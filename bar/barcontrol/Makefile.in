# ----------------------------------------------------------------------------
#
# $Source: /home/torsten/cvs/bar/barcontrol/Makefile.in,v $
# $Revision: 1.3 $
# $Author: torsten $
# Contents: Makefile for barcontrol
# Systems: all
#			   
# ----------------------------------------------------------------------------

#------------------------------------ paths ----------------------------------

#--------------------------------- tool chain --------------------------------

JAVA         = @JAVA@
JAVA_FLAGS   = @JAVA_FLAGS@

JAVAC        = @JAVAC@
JAVAC_FLAGS  = @JAVAC_FLAGS@
# -Xlint

JAR          = @JAR@

SWT_DIR      = @SWT_DIR@
SWT_JAR      = $(SWT_DIR)/swt.jar

LAUNCH4J_DIR = @LAUNCH4J_DIR@

CLASSPATH    = classes:$(SWT_JAR)

#---------------------------------- commands----------------------------------

CAT        = cat
CD         = cd
CHMOD      = chmod
CP         = cp
DIFF       = diff
ECHO       = echo
ECHO_NO_LF = echo -n
INSTALL    = @INSTALL@
MKDIR      = mkdir
PERL       = @PERL@
RMDIR      = rmdir
RMF        = rm -f
RMRF       = rm -rf
TAR        = tar
UNZIP      = unzip

#------------------------ specific variables/settings ------------------------

#---------------------------------- rules ------------------------------------

classes/%.class:src/%.java
	$(INSTALL) -d classes
	$(JAVAC) $(JAVAC_FLAGS) -d classes -classpath $(CLASSPATH) src/*.java

#--------------------------------- objects -----------------------------------

SOURCES        = src/BARControl.java \
                 src/BARServer.java \
                 \
                 src/TableLayout.java \
                 src/TableLayoutData.java \
                 src/ProgressBar.java \
                 src/Widgets.java \
                 src/Dialogs.java \
                 src/StringParser.java \

OTHER_SOURCES  = jar.txt \

OBJECTS        = $(foreach z,$(SOURCES),$(basename $(subst src/,classes/,$z)).class) \

INTERMEDIATE   = barcontrol.jar \
                 barcontrol-linux.jar \
                 barcontrol-windows.jar

TARGETS        = barcontrol \
                 $(if $(LAUNCH4J),barcontrol.exe,barcontrol.bat) \

#------------------------------ dependencies ---------------------------------

.PHONY: all clean distclean depend
all: $(TARGETS)

clean:
	$(RMF) $(OBJECTS)
	$(RMF) $(INTERMEDIATE)
	$(RMF) classes/*.class
	$(RMF) $(TARGETS)

distclean: clean
	$(RMF) Makefile
	$(RMRF) tmp

.PHONE: jars
jars: barcontrol.jar barcontrol-linux.jar barcontrol-windows.jar

# create jars
barcontrol.jar: jar.txt $(OBJECTS) images/*.gif
	$(INSTALL) -d tmp/jar
	$(CP) classes/*.class tmp/jar
	$(INSTALL) -d tmp/jar/images
	$(CP) images/*.gif tmp/jar/images
	($(CD) tmp/jar; $(JAR) cmf ../../jar.txt ../../$@ *)
	$(RMRF) tmp/jar

barcontrol-linux.jar: jar.txt $(OBJECTS) images/*.gif jars/swt-3.4-linux.jar
	$(INSTALL) -d tmp/jar
	($(CD) tmp/jar; $(UNZIP) ../../jars/swt-3.4-linux.jar 1>/dev/null; $(RMRF) META-INF)
	$(CP) classes/*.class tmp/jar
	$(INSTALL) -d tmp/jar/images
	$(CP) images/*.gif tmp/jar/images
	($(CD) tmp/jar; $(JAR) cmf ../../jar.txt ../../$@ *)
	$(RMRF) tmp/jar

barcontrol-windows.jar: jar.txt $(OBJECTS) images/*.gif jars/swt-3.4-windows.jar
	$(INSTALL) -d tmp/jar
	($(CD) tmp/jar; $(UNZIP) ../../jars/swt-3.4-windows.jar 1>/dev/null; $(RMRF) META-INF)
	$(CP) classes/*.class tmp/jar
	$(INSTALL) -d tmp/jar/images
	$(CP) images/*.gif tmp/jar/images
	($(CD) tmp/jar; $(JAR) cmf ../../jar.txt ../../$@ *)
	$(RMRF) tmp/jar

# create Unix start script
barcontrol: barcontrol-linux.jar
	@$(ECHO) >$@  "#!/bin/sh"
	@$(ECHO) >>$@ ""
	@$(ECHO) >>$@ "java -jar barcontrol-linux.jar \"$$@\""
	@$(CHMOD) 775 $@

ifneq ($(LAUNCH4J),)
# create Windows executable
barcontrol.exe: barcontrol-windows.jar
	$(LAUNCH4J) barcontrol.xml
else
# create Windows start script
barcontrol.bat: barcontrol-windows.jar
	@$(ECHO) >>$@ "java -classpath swt.jar\;barcontrol.jar BARControl %*"
	@$(CHMOD) 775 $@
endif

# run
run: $(OBJECTS)
	$(JAVA) $(JAVA_FLAGS) -classpath $(CLASSPATH) BARControl

# run with jar file
runjar: barcontrol
	./barcontrol

# copy distribution files
.PHONY: dist
dist:
	$(INSTALL) -d $(DIRECTORY)/barcontrol
	$(INSTALL) -d $(DIRECTORY)/barcontrol/src
	$(INSTALL) -m 664 \
                   Makefile.in \
                   barcontrol.cfg \
                   $(DIRECTORY)/barcontrol
	$(INSTALL) -m 664 \
                   $(sort $(SOURCES)) \
                   $(DIRECTORY)/barcontrol/src
	$(INSTALL) -d $(DIRECTORY)/barcontrol/classes
	$(INSTALL) -m 664 \
                   $(sort $(OTHER_SOURCES)) \
                   $(DIRECTORY)/barcontrol
	$(INSTALL) -d $(DIRECTORY)/barcontrol/images
	$(INSTALL) -m 664 \
                   images/*.gif \
                   $(DIRECTORY)/barcontrol/images
	$(INSTALL) -d $(DIRECTORY)/barcontrol/jars
	$(INSTALL) -m 664 \
                   jars/*.jar \
                   $(DIRECTORY)/barcontrol/jars

# end of file
