VERSION = 1.0
INSTALL_PATH = /usr/local

CC                  = @CC@
CC_FLAGS            = -Wall -g -fPIC @CC_FLAGS@ @CC_WARN_FLAGS@ @CC_OPTIMIZE@
CC_DEFINES          = @CC_DEFINES@
CC_INCLUDES         = /usr/local/include /usr/include @CC_INCLUDES@

LD                  = @LD@
LD_FLAGS            = @LD_FLAGS@ -G -z text
LD_LIBRARY_PATHS    = /usr/local/lib /usr/lib
LD_LIBRARIES        = 
LD_STATIC_LIBRARIES = 

%.o:%.c
	$(CC) $(CC_FLAGS) $(foreach z,$(CC_DEFINES),-D$z) $(for z,$(CC_INCLUDES),-I$z) -c $*.c -o $*.o

.PHONY: all clean
all: libscanx.so pkgIndex.tcl

clean:
	rm -f scanx.o tclScanx.o libscanx.so
	rm -f pkgIndex.tcl

scanx.o: scanx.c

tclScanx.o: tclScanx.c

libscanx.so: scanx.o tclScanx.o
	$(LD) \
          $(LD_FLAGS) \
          -o $@ \
          $^ \
          $(foreach z,$(LD_LIBRARY_PATHS),-L$z) \
          $(foreach z,$(LD_LIBRARIES),-l$z)

.PHONY: test
test: libscanx.so
	tclsh scanx_test.tcl

pkgIndex.tcl:
	@echo >$@  '# pkgIndex.tcl - scanx'
	@echo >>$@ ''
	@echo >>$@ 'package ifneeded scanx $(VERSION) "[list load [file join $$dir .. libscanx$(VERSION).so]]"'

install: libscanx.so pkgIndex.tcl
	install -d $(INSTALL_PATH)/lib/scanx$(VERSION)
	install libscanx.so $(INSTALL_PATH)/lib/libscanx$(VERSION).so
	install pkgIndex.tcl $(INSTALL_PATH)/lib/scanx$(VERSION)
