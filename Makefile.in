# ----------------------------------------------------------------------------
#
# Contents: Makefile for bar
# Systems: all
#
# ----------------------------------------------------------------------------

#----------------------------- external variables ----------------------------
#
# DESTDIR=<path>    install destination directory
# DIST=1            install for creating distribution packages

#---------------------------------- settings ---------------------------------

ENABLE_DEBUG           = @ENABLE_DEBUG@
ENABLE_GUI             = @ENABLE_GUI@

PLATFORM               = @PLATFORM@

#------------------------------------ paths ----------------------------------

ROOT_DIR               = $(abspath @srcdir@)
SOURCE_DIR             = $(abspath @srcdir@)
BUILD_DIR              = $(CURDIR)

ETC_DIR                = /etc

ifeq ($(DESTDIR),)
INSTALL_DIR            = $(if $(prefix),$(prefix),@INSTALL_DIR@)
INSTALL_BIN_DIR        = $(if $(bindir),$(bindir),@INSTALL_BIN_DIR@)
INSTALL_LIB_DIR        = $(if $(libdir),$(libdir),/usr/lib)
INSTALL_LOCALE_DIR     = $(if $(datadir),$(datadir)/locale,@LOCALE_DIR@)
INSTALL_ETC_DIR        = $(if $(sysconfdir),$(sysconfdir),$(ETC_DIR))
#INSTALL_INITD_DIR      = $(INSTALL_ETC_DIR)/$(if $(wildcard $(ETC_DIR)/rc.d),rc.d/init.d,init.d)
INSTALL_INITD_DIR      = $(INSTALL_ETC_DIR)/init.d
INSTALL_LOGROTATED_DIR = $(INSTALL_ETC_DIR)/logrotate.d
INSTALL_CONFIG_DIR     = $(if $(sysconfdir),$(sysconfdir)/bar,@CONFIG_DIR@)
INSTALL_MAN_DIR        = $(if $(mandir),$(mandir),@MAN_DIR@)
else
INSTALL_DIR            = @INSTALL_DIR@
INSTALL_BIN_DIR        = @INSTALL_BIN_DIR@
INSTALL_LIB_DIR        = /usr/lib
INSTALL_LOCALE_DIR     = @LOCALE_DIR@
INSTALL_ETC_DIR        = $(ETC_DIR)
#INSTALL_INITD_DIR      = $(INSTALL_ETC_DIR)/$(if $(wildcard $(ETC_DIR)/rc.d),rc.d/init.d,init.d)
INSTALL_INITD_DIR      = $(INSTALL_ETC_DIR)/init.d
INSTALL_LOGROTATED_DIR = $(INSTALL_ETC_DIR)/logrotate.d
INSTALL_CONFIG_DIR     = @CONFIG_DIR@
INSTALL_MAN_DIR        = @MAN_DIR@
endif
INSTALL_TLS_DIR        = @TLS_DIR@

#--------------------------------- tool chain --------------------------------

CERTTOOL               = @CERTTOOL@
OPENSSL                = @OPENSSL@
KEYTOOL                = @KEYTOOL@

DOCKER_RUN_FLAGS       = run -i -t
DOCKER_PROMPT          = '\[\e[0;38;5;39m\]\u\[\e[0;38;5;39m\]@\[\e[0;38;5;39m\]\H\[\e[0;38;5;39m\]:\[\e[0;38;5;39m\]\w \[\e[0;38;5;39m\]$$ \[\e[0m\]'

TXT2MAN                = @TXT2MAN@
UNOCONV                = @UNOCONV@

LAUNCH4JC              = @LAUNCH4JC@

#---------------------------------- commands----------------------------------

CAT                    = cat
CD                     = cd
CHMOD                  = chmod
CP                     = cp
CUT                    = cut
DIFF                   = diff
DOCKER                 = @DOCKER@
ECHO                   = echo
ECHO_NO_LF             = echo -n
GIT                    = @GIT@
GREP                   = grep
INSTALL                = @INSTALL@
LN                     = ln
MD5SUM                 = @MD5SUM@
MKDIR                  = mkdir
MV                     = mv
NROFF                  = nroff
PERL                   = @PERL@
PRINTF                 = printf
RMDIR                  = rmdir
RMF                    = rm -f
RMRF                   = rm -rf
SED                    = sed
TAR                    = tar
TAIL                   = tail
TR                     = tr
WINE                   = @WINE@
WINE_C_DRIVE           = @WINE_C_DRIVE@
ZIP                    = zip

#------------------------ specific variables/settings ------------------------

# special constants
EMPTY                       :=
SPACE                       := $(EMPTY) $(EMPTY)
COMMA                       := ,

# shell in Makefile must be bash with pipe-fail handling
SHELL                       = bash -o pipefail

VERSION_MAJOR               := $(shell $(CAT) $(SOURCE_DIR)/version|$(GREP) MAJOR|$(SED) 's/MAJOR=//g')
VERSION_MINOR               := $(shell $(CAT) $(SOURCE_DIR)/version|$(GREP) MINOR|$(SED) 's/MINOR=//g')
VERSION_PATCH               := $(shell $(CAT) $(SOURCE_DIR)/version|$(GREP) PATCH|$(SED) 's/PATCH=//g')
VERSION                     := $(VERSION_MAJOR)$(if $(VERSION_MINOR),$(if $(VERSION_MAJOR),.)$(VERSION_MINOR))$(VERSION_PATCH)

PACKAGE_NAME                = backup-archiver
PACKAGE_NAME_GUI            = backup-archiver-gui
DISTRIBUTION_NAME           = $(PACKAGE_NAME)-$(VERSION)
DISTRIBUTION_NAME_ORIG      = $(PACKAGE_NAME)_$(VERSION).orig
DISTRIBUTION_NAME_GUI       = $(PACKAGE_NAME_GUI)-$(VERSION)

# Note: also change ci/packages.jenkinsfile
TEST_PACKAGES_ALMALINUX     := 8.10 9.0 9.1 9.2 9.3 9.4 9.5
TEST_PACKAGES_FEDORA        := 37 38 39 40 41 42
TEST_PACKAGES_OPENSUSE_LEAP := 15.1 15.2 15.3 15.4 15.5 15.6
TEST_PACKAGES_DEBIAN        := 11 12 13
TEST_PACKAGES_UBUNTU        := 20.04 22.04 24.04 24.10 25.04

#-------------------------------- functions ----------------------------------

# print info line
# $(call functionPrintInfo,text)
functionPrintInfo = \
  $(if $(QUIET), \
    $(ECHO_NO_LF) "$1...",\
    $(PRINTF) -vl "%$${COLUMNS:-`tput cols 2>&-||$(ECHO) 80`}s\n" && $(PRINTF) -vl -- "--- $1 $${l// /-}\n" && $(ECHO) $${l:0:`tput cols 2>&-||$(ECHO) 80`}\
   )

# print result
# $(call functionPrintResult,text)
functionPrintResult = \
  $(if $(QUIET), \
    $(ECHO) "$1",\
    $(PRINTF) -vl "%$${COLUMNS:-`tput cols 2>&-||$(ECHO) 80`}s\n" && $(PRINTF) -vl -- "--- $1 $${l// /-}\n" && $(ECHO) $${l:0:`tput cols 2>&-||$(ECHO) 80`}\
   )

#---------------------------------- rules ------------------------------------

#--------------------------------- objects -----------------------------------

TARGETS              = bar/bar@EXEEXT@ \
                       bar/bar-debug@EXEEXT@ \
                       bar/bar-gcov@EXEEXT@ \
                       bar/bar-gprof@EXEEXT@ \
                       bar/bar-valgrind@EXEEXT@ \
                       bar/destroyer@EXEEXT@ \
                       bar/bar-keygen@SHELLEXT@ \
                       $(if $(findstring $(ENABLE_GUI),yes),\
                         $(if $(findstring $(PLATFORM),LINUX),\
                           barcontrol/barcontrol \
                         ) \
                         $(if $(findstring $(PLATFORM),WINDOWS),\
                           barcontrol/barcontrol.cmd \
                           $(if $(LAUNCH4JC),barcontrol/barcontrol@EXEEXT@) \
                         ) \
                       ) \

OTHER_SOURCES        = $(SOURCE_DIR)/errors.pl \
                       $(SOURCE_DIR)/errors.def \

KEY_FILES            = bar-key.pem \
                       bar-ca.pem \
                       bar-server-key.pem \
                       bar-server-cert.pem \

SCRIPTS              = $(SOURCE_DIR)/scripts/barserver-SuSE \
                       $(SOURCE_DIR)/scripts/barserver-Fedora \
                       $(SOURCE_DIR)/scripts/barserver-RedHat \
                       $(SOURCE_DIR)/scripts/barserver-Mandrake \
                       $(SOURCE_DIR)/scripts/barserver-debian \
                       $(SOURCE_DIR)/scripts/barserver-AlmaLinux \
                       $(SOURCE_DIR)/scripts/barserver.service \
                       $(SOURCE_DIR)/scripts/logrotate.conf \

#------------------------------ dependencies ---------------------------------

.PHONY: all clean distclean

all: \
  $(TARGETS) \

clean: \
  clean_keys \
  clean_doc \
  clean_rpm \
  clean_deb \
  clean_win32
	-$(MAKE) -C bar clean
ifeq ($(ENABLE_GUI),yes)
	-$(MAKE) -C barcontrol clean
endif
	$(RMRF) $(DISTRIBUTION_NAME)
	$(RMF) $(DISTRIBUTION_NAME).tar.bz2 $(DISTRIBUTION_NAME).orig.tar.gz
	$(RMRF) tmp

distclean: clean
	-$(MAKE) -C bar distclean
ifeq ($(ENABLE_GUI),yes)
	-$(MAKE) -C barcontrol distclean
endif
	$(ROOT_DIR)/download-third-party-packages.sh --clean
	$(RMRF) extern
	$(RMF) Makefile
	$(RMF) src/Config.java
	$(RMF) config.status
	$(RMF) config.log
	$(RMRF) build

# help
.PHONY: help
help:
	@$(ECHO) "Help targets:"
	@$(ECHO) ""
	@$(ECHO) "  all "
	@$(ECHO) "  clean "
	@$(ECHO) "  distclean"
	@$(ECHO) ""
	@$(ECHO) "  bar"
	@$(ECHO) "  bar-keygen"
	@$(ECHO) "  barcontrol"
	@$(ECHO) ""
	@$(ECHO) "  keys"
	@$(ECHO) ""
	@$(ECHO) "  doc"
	@$(ECHO) "  clean_doc"
	@$(ECHO) "  man"
	@$(ECHO) "  showman"
	@$(ECHO) "  pdf"
	@$(ECHO) ""
	@$(ECHO) "  install"
	@$(ECHO) ""
	@$(ECHO) "  tests"
	@$(ECHO) "  tests1[-debug|-valgrind], test_basic"
	@$(ECHO) "  tests2[-debug|-valgrind], test_compress"
	@$(ECHO) "  tests3[-debug|-valgrind], test_crypt"
	@$(ECHO) "  tests4[-debug|-valgrind], test_asymmetric_crypt"
	@$(ECHO) "  tests5[-debug|-valgrind], test_signatures"
	@$(ECHO) "  tests6[-debug|-valgrind], test_split"
	@$(ECHO) "  tests7[-debug|-valgrind], test_convert"
	@$(ECHO) "  tests8[-debug|-valgrind], test_image"
	@$(ECHO) "  tests9[-debug|-valgrind], test_storage"
	@$(ECHO) "  tests10[-debug|-valgrind], test_huge"
	@$(ECHO) "  tests11[-debug|-valgrind], test_index"
	@$(ECHO) "  tests12[-debug|-valgrind], test_server"
	@$(ECHO) "  tests13[-debug|-valgrind], test_master_slave"
	@$(ECHO) "  tests_combined"
	@$(ECHO) "  tests_arguments"
	@$(ECHO) "  tests_config"
	@$(ECHO) "  tests_miscellaneous"
	@$(ECHO) "  tests_smoke"
	@$(ECHO) ""
	@$(ECHO) "  memcheck"
	@$(ECHO) "  memcheck_extended"
	@$(ECHO) ""
	@$(ECHO) "  dist"
	@$(ECHO) "  clean_dist"
	@$(ECHO) "  debian_dist"
	@$(ECHO) "  clean_debian_dist"
	@$(ECHO) ""
	@$(ECHO) "  rpm[d]"
	@$(ECHO) "  rpm32[d]"
	@$(ECHO) "  rpm64[d]"
	@$(ECHO) "  clean_rpm"
	@$(ECHO) ""
	@$(ECHO) "  deb[d]"
	@$(ECHO) "  deb32[d]"
	@$(ECHO) "  deb64[d]"
	@$(ECHO) "  clean_deb"
	@$(ECHO) ""
	@$(ECHO) "  win32"
	@$(ECHO) "  clean_win32"
	@$(ECHO) ""
	@$(ECHO) "  docker_build"
	@$(ECHO) "  docker_purge"
	@$(ECHO) ""
	@$(ECHO) "  docker_run"
	@$(ECHO) "  docker_run_win32"
	@$(ECHO) "  docker_run_win32-x86_64"
	@$(ECHO) ""
	@$(ECHO) "  docker_rpm"
	@$(ECHO) "  docker_den"
	@$(ECHO) "  docker_win32"
	@$(ECHO) ""
	@$(ECHO) "  install_test[d]"
	@$(ECHO) ""
	@$(ECHO) "  install_test_rpm[d]"
	@$(ECHO) "  install_test_rpm_almalinux8-x86_64[d]"
	@$(ECHO) "  install_test_rpm_fedora[$(subst $(SPACE),\|,$(TEST_PACKAGES_FEDORA))]-x86_64[d]"
	@$(ECHO) "  install_test_rpm_opensuse-tumbleweed-x86_64[d]"
	@$(ECHO) "  install_test_rpm_opensuse-leap[$(subst $(SPACE),\|,$(TEST_PACKAGES_OPENSUSE_LEAP))]-x86_64[d]"
	@$(ECHO) ""
	@$(ECHO) "  install_test_deb[d]"
	@$(ECHO) "  install_test_deb_debian[$(subst $(SPACE),\|,$(TEST_PACKAGES_DEBIAN))]-x86_64[d]"
	@$(ECHO) "  install_test_deb_ubuntu[$(subst $(SPACE),\|,$(TEST_PACKAGES_UBUNTU))]-x86_64[d]"
	@$(ECHO) ""
	@$(ECHO) "  install_test_win32[d]"
	@$(ECHO) ""
	@$(ECHO) "  gui"
	@$(ECHO) "  clean_gui"

# create dependencies
.PHONY: depend
depend:
	$(MAKE) -j1 -C bar depend
	$(MAKE) -j1 -C barcontrol depend

# ----------------------------------------------------------------------------
# create bar
bar/%:
	$(MAKE) -C bar $*

.PHONY: bar bar-debug bar-gcov bar-gprof bar-valgrind
bar:
	$(MAKE) -C bar bar
bar-debug:
	$(MAKE) -C bar bar-debug
bar-gcov:
	$(MAKE) -C bar bar-gcov
bar-gprof:
	$(MAKE) -C bar bar-gprof
bar-valgrind:
	$(MAKE) -C bar bar-valgrind

# create bar-keygen
.PHONY: bar-keygen
bar-keygen:
	$(MAKE) -C bar bar-keygen

# create barcontrol
.PHONY: barcontrol
barcontrol/barcontrol barcontrol:
ifeq ($(ENABLE_GUI),yes)
	$(MAKE) -C barcontrol barcontrol
else
	@$(ECHO) "ERROR: GUI components not configured - cannot be build."
endif

barcontrol/barcontrol.cmd:
ifeq ($(ENABLE_GUI),yes)
	$(MAKE) -C barcontrol barcontrol.cmd
else
	@$(ECHO) "ERROR: GUI components not configured - cannot be build."
endif
ifeq ($(PLATFORM),WINDOWS)
ifneq ($(LAUNCH4JC),)
barcontrol/barcontrol@EXEEXT@:
ifeq ($(ENABLE_GUI),yes)
	$(MAKE) -C barcontrol barcontrol@EXEEXT@
else
	@$(ECHO) "ERROR: GUI components not configured - cannot be build."
endif
endif
endif

barcontrol/barcontrol%.jar:
ifeq ($(ENABLE_GUI),yes)
	$(MAKE) -C barcontrol barcontrol$*.jar
else
	@$(ECHO) "ERROR: GUI components not configured - cannot be build."
endif

# ----------------------------------------------------------------------------
# create SSL keys and certificates

.PHONY: keys clean_keys
keys: \
  $(KEY_FILES)

clean_keys:
	$(RMF) $(KEY_FILES)

$(KEY_FILES):
	$(MAKE) -C bar bar-keygen@SHELLEXT@
	($(CD) bar; \
         ./bar-keygen@SHELLEXT@ \
           --tls-directory=.. \
           --private-directory=.. \
           --certs-directory=.. \
           $(if $(CERTTOOL),--certtool) \
           $(if $(OPENSSL),--openssl) \
           --force \
        )

# ----------------------------------------------------------------------------
# create documentation

.PHONY: doc clean_doc showman pdf
doc:
	@$(MAKE) -C doc

clean_doc:
	@$(MAKE) -C doc clean

# create man-page
.PHONY: man clean_man showman
man:
	@$(MAKE) -C doc man

clean_man:
	@$(MAKE) -C doc clean_man

showman:
	@$(MAKE) -C doc showman

# create manual
pdf doc/backup-archiver.pdf:
	@$(MAKE) -C doc backup-archiver.pdf

# ----------------------------------------------------------------------------
# install/uninstall
# Note: prefix DESTDIR is used for temporary installations

.PHONY: install install_bar install_barcontrol install_scripts install_man install_keys uninstall install_dist
install: \
  install_bar \
  install_barcontrol \
  install_scripts \
  install_man \
  $(if $(DIST),,install_keys)

install_bar:
	$(MAKE) -C bar install \
          prefix=$(prefix) \
          bindir=$(bindir) \
          libdir=$(libdir) \
          datadir=$(datadir) \
          sysconfdir=$(sysconfdir) \
          mandir=$(mandir) \
          DESTDIR=$(DESTDIR)

install_barcontrol:
	$(MAKE) -C barcontrol install \
          prefix=$(prefix) \
          bindir=$(bindir) \
          libdir=$(libdir) \
          datadir=$(datadir) \
          sysconfdir=$(sysconfdir) \
          mandir=$(mandir) \
          DESTDIR=$(DESTDIR)

# install script files
install_scripts: \
  $(SCRIPTS)
	$(INSTALL) -d "$(DESTDIR)$(INSTALL_LOGROTATED_DIR)"; \
	$(INSTALL) -m 644 scripts/logrotate.conf "$(DESTDIR)$(INSTALL_LOGROTATED_DIR)/bar"; \
	$(INSTALL) -d "$(DESTDIR)/var/lib/bar/install"; \
	$(INSTALL) -t "$(DESTDIR)/var/lib/bar/install" \
          scripts/barserver-SuSE \
          scripts/barserver-Fedora \
          scripts/barserver-RedHat \
          scripts/barserver-AlmaLinux \
          scripts/barserver-Mandrake \
          scripts/barserver-debian \
          scripts/barserver.service

# install man-page
install_man:
	$(MAKE) -C doc install_man

# install keys
# Note: prefix is used for temporary installations
install_keys: \
  $(KEY_FILES)
	$(INSTALL) -d "$(DESTDIR)$(INSTALL_TLS_DIR)"
	$(INSTALL) -d "$(DESTDIR)$(INSTALL_TLS_DIR)/certs"
	$(INSTALL) -m 644 bar-ca.pem "$(DESTDIR)$(INSTALL_TLS_DIR)/certs"
	$(INSTALL) -m 644 bar-server-cert.pem "$(DESTDIR)$(INSTALL_TLS_DIR)/certs"
	$(INSTALL) -d -m 700 "$(DESTDIR)$(INSTALL_TLS_DIR)/private"
	$(INSTALL) -m 600 bar-server-key.pem "$(DESTDIR)$(INSTALL_TLS_DIR)/private"
	$(INSTALL) -m 600 bar-key.pem "$(DESTDIR)$(INSTALL_TLS_DIR)/private"

# uninstall all
uninstall:
	@read -n 1 -p "Really uninstall? [y/N] " s; \
        if test "$s" = "y" -o "$s" = "Y"; then \
          $(RMF) "$(DESTDIR)$(INSTALL_BIN_DIR)/bar@EXEEXT@"; \
          $(RMF) "$(DESTDIR)$(INSTALL_BIN_DIR)/bar-keygen@SHELLEXT@"; \
          $(if $(findstring $(ENABLE_GUI),yes),$(RMF) "$(DESTDIR)$(INSTALL_BIN_DIR)/barcontrol" \
                                                      "$(DESTDIR)$(INSTALL_BIN_DIR)/barcontrol.jar" \
                                                      "$(DESTDIR)$(INSTALL_BIN_DIR)/barcontrol@EXEEXT@"; \
          ) \
          $(RMF) "$(DESTDIR)$(INSTALL_CONFIG_DIR)/bar.cfg"; \
          $(RMF) "$(DESTDIR)$(INSTALL_TLS_DIR)/certs/bar-ca.pem"; \
          $(RMF) "$(DESTDIR)$(INSTALL_TLS_DIR)/certs/bar-server-cert.pem"; \
          $(RMF) "$(DESTDIR)$(INSTALL_TLS_DIR)/private/bar-server-key.pem"; \
          $(if $(findstring $(ENABLE_GUI),yes),$(RMF) "$(DESTDIR)$(INSTALL_CONFIG_DIR)"; \
          ) \
          $(RMF) "$(DESTDIR)$(INSTALL_INITD_DIR)/barserver"; \
          $(RMF) "$(DESTDIR)$(INSTALL_LOGROTATED_DIR)/bar"; \
          $(RMF) "$(DESTDIR)$(INSTALL_MAN_DIR)/man7"; \
        fi

# ----------------------------------------------------------------------------
# tests

# run server
.PHONY: barserver barserver_ssl
barserver:
	@$(MAKE) -C bar barserver

barserver_ssl:
	@$(MAKE) -C bar barserver_ssl

# do tests
.PHONY: tests test test% test%-debug test%-gcov test%-gprof test%-valgrind
tests test:
	@$(MAKE) -C bar $@
test%:
	@$(MAKE) -C bar $@
test%-debug:
	@$(MAKE) -C bar $@
test%-gcov:
	@$(MAKE) -C bar $@
test%-gprof:
	@$(MAKE) -C bar $@
test%-valgrind:
	@$(MAKE) -C bar $@

# memory checks
.PHONY: memcheck memcheck1 memcheck_extended
memcheck:
	@$(MAKE) -C bar memcheck

memcheck_extended:
	@$(MAKE) -C bar memcheck_extended

# ----------------------------------------------------------------------------
# distribution

.PHONY: distribution dist clean_distribution clean_dist
distribution dist:
	$(RMF) $(DISTRIBUTION_NAME).tar.bz2
	$(MAKE) $(DISTRIBUTION_NAME).tar.bz2

clean_distribution clean_dist:
	$(RMF) $(DISTRIBUTION_NAME).tar.bz2

# create distribution
$(DISTRIBUTION_NAME).tar.bz2: \
  $(SOURCE_DIR)/configure \
  $(SOURCE_DIR)/configure.ac \
  $(SOURCE_DIR)/Makefile.in \
  $(SOURCE_DIR)/version \
  $(SOURCE_DIR)/ToDo \
  $(SOURCE_DIR)/ChangeLog \
  \
  $(SOURCE_DIR)/download-third-party-packages.sh \
  $(OTHER_SOURCES) \
  \
  $(SOURCE_DIR)/bin/config.guess \
  $(SOURCE_DIR)/bin/config.sub \
  $(SOURCE_DIR)/bin/install-sh \
  $(SOURCE_DIR)/bin/config.guess \
  \
  $(SOURCE_DIR)/bar/Makefile.in \
  $(SOURCE_DIR)/bar/tests/Makefile.in \
  $(SOURCE_DIR)/barcontrol/Makefile.in \
  \
  $(SOURCE_DIR)/ssl/certtool/*.tmpl \
  $(SOURCE_DIR)/ssl/openssl/*.tmpl \
  \
  $(SCRIPTS) \
  \
  $(SOURCE_DIR)/misc/*.patch \
  \
  $(SOURCE_DIR)/packages/*
	$(INSTALL) -d tmp/$(DISTRIBUTION_NAME)
	$(INSTALL) -m 775 \
                   -t tmp/$(DISTRIBUTION_NAME) \
                   $(SOURCE_DIR)/configure \
                   $(SOURCE_DIR)/download-third-party-packages.sh \
                   $(OTHER_SOURCES)
	$(INSTALL) -m 664 \
                   -t tmp/$(DISTRIBUTION_NAME) \
                   $(SOURCE_DIR)/configure.ac \
                   $(SOURCE_DIR)/Makefile.in \
                   $(SOURCE_DIR)/ToDo \
                   $(SOURCE_DIR)/ChangeLog
	( \
          $(GREP) MAJOR $(SOURCE_DIR)/version; \
          $(GREP) MINOR $(SOURCE_DIR)/version; \
          $(GREP) PATCH $(SOURCE_DIR)/version; \
          $(ECHO) "RELEASE=$(shell $(GIT) rev-parse HEAD)"; \
        ) > tmp/$(DISTRIBUTION_NAME)/version
	$(INSTALL) -d tmp/$(DISTRIBUTION_NAME)/bin
	$(INSTALL) -m 664 \
                   -t tmp/$(DISTRIBUTION_NAME)/bin \
                   $(SOURCE_DIR)/bin/config.guess \
                   $(SOURCE_DIR)/bin/config.sub \
                   $(SOURCE_DIR)/bin/install-sh
	$(MAKE) -C bar dist DIRECTORY="../tmp/$(DISTRIBUTION_NAME)"
	$(MAKE) -C barcontrol dist DIRECTORY="../tmp/$(DISTRIBUTION_NAME)"
	$(MAKE) -C doc dist DIRECTORY="../tmp/$(DISTRIBUTION_NAME)"
	#
	$(INSTALL) -d tmp/$(DISTRIBUTION_NAME)/ssl
	$(INSTALL) -d tmp/$(DISTRIBUTION_NAME)/ssl/certtool
	$(INSTALL) -m 664 \
                   -t tmp/$(DISTRIBUTION_NAME)/ssl/certtool \
                   $(SOURCE_DIR)/ssl/certtool/*.tmpl
	$(INSTALL) -d tmp/$(DISTRIBUTION_NAME)/ssl/openssl
	$(INSTALL) -m 664 \
                   -t tmp/$(DISTRIBUTION_NAME)/ssl/openssl \
                   $(SOURCE_DIR)/ssl/openssl/*.tmpl
	#
	$(INSTALL) -d tmp/$(DISTRIBUTION_NAME)/scripts
	$(INSTALL) -m 664 \
                   -t tmp/$(DISTRIBUTION_NAME)/scripts \
                   $(SCRIPTS)
	#
	$(INSTALL) -d tmp/$(DISTRIBUTION_NAME)/misc
	$(INSTALL) -m 664 \
                   -t tmp/$(DISTRIBUTION_NAME)/misc \
                   $(SOURCE_DIR)/misc/*.patch
	#
	$(INSTALL) -d tmp/$(DISTRIBUTION_NAME)/packages
	$(INSTALL) -m 664 \
                   -t tmp/$(DISTRIBUTION_NAME)/packages \
                   $(SOURCE_DIR)/packages/*.dockerfile \
                   $(SOURCE_DIR)/packages/*.spec \
                   $(SOURCE_DIR)/packages/*.iss \
                   $(SOURCE_DIR)/packages/*.sh
	$(INSTALL) -m 775 \
                   -t tmp/$(DISTRIBUTION_NAME)/packages \
                   $(SOURCE_DIR)/packages/changelog.pl
	$(INSTALL) -d tmp/$(DISTRIBUTION_NAME)/packages/debian
	$(INSTALL) -m 664 \
                   -t tmp/$(DISTRIBUTION_NAME)/packages/debian \
                   $(SOURCE_DIR)/packages/debian/compat \
                   $(SOURCE_DIR)/packages/debian/conffiles \
                   $(SOURCE_DIR)/packages/debian/control \
                   $(SOURCE_DIR)/packages/debian/copyright \
                   $(SOURCE_DIR)/packages/debian/postinst \
                   $(SOURCE_DIR)/packages/debian/postrm \
                   $(SOURCE_DIR)/packages/debian/preinst \
                   $(SOURCE_DIR)/packages/debian/prerm \
                   $(SOURCE_DIR)/packages/debian/rules
	$(INSTALL) -d tmp/$(DISTRIBUTION_NAME)/packages/debian/source
	$(INSTALL) -m 664 \
                   -t tmp/$(DISTRIBUTION_NAME)/packages/debian/source \
                   $(SOURCE_DIR)/packages/debian/source/format
	#
	($(CD) tmp; $(TAR) cjf ../$@ $(DISTRIBUTION_NAME))
	$(RMRF) tmp
	#
ifneq ($(MD5SUM),)
	$(MD5SUM) $@
endif

# --- Debian distribution
.PHONY: debian_dist clean_debian_dist $(DISTRIBUTION_NAME).orig.tar.gz
debian_dist: \
  $(DISTRIBUTION_NAME).orig.tar.gz

clean_debian_dist:
	$(RMF) $(DISTRIBUTION_NAME).orig.tar.gz

# create Debian distribution
$(DISTRIBUTION_NAME).orig.tar.gz: \
  $(DISTRIBUTION_NAME).tar.bz2 \
  download-third-party-packages.sh
	$(INSTALL) -d tmp/$(DISTRIBUTION_NAME).orig
	($(CD) tmp/$(DISTRIBUTION_NAME).orig; $(TAR) --strip-components=1 -xjf ../../$(DISTRIBUTION_NAME).tar.bz2)
	$(INSTALL) -d tmp/$(DISTRIBUTION_NAME).orig/extern
        # copy existing packages to avoid download (which may fail because of an instable Internet)
	$(INSTALL) \
          extern/binutils-*.tar.bz2 \
          extern/bzip2-*.tar.gz \
          extern/c-ares-*.tar.gz \
          extern/curl-*.tar.bz2 \
          extern/gmp-*.tar.xz \
          extern/gnutls-*.tar.xz \
          extern/icu*.tgz \
          extern/libiconv-*.tar.gz \
          extern/libcdio-*.tar.gz \
          extern/libgcrypt-*.tar.bz2 \
          extern/libgpg-error-*.tar.bz2 \
          extern/libssh2-*.tar.gz \
          extern/lz4-*.tar.gz \
          extern/lzo-*.tar.gz \
          extern/mtx-*.tar.gz \
          extern/mxml-*.tar.gz \
          extern/nettle-*.tar.gz \
          extern/openssl-*.tar.gz \
          extern/pcre-*.tar.bz2 \
          extern/sqlite-src-*.zip \
          extern/pthreads-w32-*.tar.gz \
          extern/xdelta*.tar.gz \
          extern/xz-*.tar.gz \
          extern/zlib-*.tar.gz \
          extern/zstd-*.zip \
          tmp/$(DISTRIBUTION_NAME).orig/extern
	$(INSTALL) \
          third-party/breakpad-r1430.tar.bz2 \
          tmp/$(DISTRIBUTION_NAME).orig/extern/breakpad.tar.bz2
	if test -n "`ls extern/ftplib-*.tar.gz 2>/dev/null`"; then \
	  $(INSTALL) \
            extern/ftplib-*.tar.gz \
            tmp/$(DISTRIBUTION_NAME).orig/extern; \
        fi
	if test -n "`ls extern/launch4j-*.tgz 2>/dev/null`"; then \
	  $(INSTALL) \
            extern/launch4j-*.tgz \
            tmp/$(DISTRIBUTION_NAME).orig/extern; \
        fi
	# download not existing packages
	./download-third-party-packages.sh --local-directory extern -d tmp/$(DISTRIBUTION_NAME).orig -n
	./download-third-party-packages.sh -d tmp/$(DISTRIBUTION_NAME).orig -n
	($(CD) tmp; $(TAR) czf ../$@ $(DISTRIBUTION_NAME).orig)
	$(RMRF) tmp/$(DISTRIBUTION_NAME).orig

# ----------------------------------------------------------------------------
# packages

.PHONY: packages
packages: \
  rpm \
  deb \
  gui

.PHONY: docker_build docker_update update_docker
docker_build docker_update update_docker:
	# base images
	$(DOCKER) pull almalinux:8.10
	$(DOCKER) pull debian:10
	$(DOCKER) pull ubuntu:22.04
	#
	$(INSTALL) download-third-party-packages.sh packages
	#
	(cd packages; $(DOCKER) build -f bar-rpm.dockerfile   -t bar-rpm   --build-arg uid=$(shell id -u jenkins) --build-arg gid=$(shell id -g jenkins) .)
	(cd packages; $(DOCKER) build -f bar-deb.dockerfile   -t bar-deb   --build-arg uid=$(shell id -u jenkins) --build-arg gid=$(shell id -g jenkins) .)
	(cd packages; $(DOCKER) build -f bar-win32.dockerfile -t bar-win32 --build-arg uid=$(shell id -u jenkins) --build-arg gid=$(shell id -g jenkins) .)
	#
	$(RMF) packages/download-third-party-packages.sh
	#
	# build image
	$(INSTALL) download-third-party-packages.sh ci
	$(INSTALL) bar/tests/bar-sudoers ci
	#
	(cd ci; $(DOCKER) build -f build.dockerfile -t bar --build-arg uid=$(shell id -u jenkins) --build-arg gid=$(shell id -g jenkins) .)
	#
	# test packages images
	$(foreach i,$(TEST_PACKAGES_ALMALINUX),$(DOCKER) pull almalinux:$i;)
	#
	$(foreach i,$(TEST_PACKAGES_FEDORA),$(DOCKER) pull fedora:$i;)
	#
	$(DOCKER) pull opensuse/tumbleweed
	$(foreach i,$(TEST_PACKAGES_OPENSUSE_LEAP),$(DOCKER) pull opensuse/leap:$i;)
	#
	$(foreach i,$(TEST_PACKAGES_DEBIAN),$(DOCKER) pull debian:$i;)
	#
	$(foreach i,$(TEST_PACKAGES_UBUNTU),$(DOCKER) pull ubuntu:$i;)
	#
	$(RMF) ci/bar-sudoers
	$(RMF) ci/download-third-party-packages.sh

.PHONY: docker_purge purge_docker
docker_purge purge_docker:
	$(DOCKER) rm $$($(DOCKER) ps -a -q)

functionGetCDEmuDevice=$(shell cdemu device-mapping |$(TAIL) -n +3|$(GREP) 0|$(TR) -s ' '|$(CUT) -d ' ' -f 2)

.PHONY: docker_run docker_run_win32 docker_run_win32-x86_64
docker_run:
	# Notes: - no image operations in docker, because /dev/loop* and mount only
	#          work with --privileges=true which may cause dangerous/instable
	#          behaviour
	#        - do not enable host network, because of sftp/ssh/apache instances
	#          in container; just map ssh port
	#        - need root privileges in container to start services
	if test -z "`cdemu device-mapping |$(TAIL) -n +3`"; then \
    cdemu add-device; \
    cdemu create-blank --writer-id=WRITER-ISO --medium-type=dvd+r 0 /tmp/bar-optical; \
  fi
	$(DOCKER) $(DOCKER_RUN_FLAGS) \
          --rm \
          -p 2222:22 \
          -e TERM=xterm-256color \
          -e COLUMNS="`tput cols`" -e LINES="`tput lines`" \
          -e TEST_BASE_DIR=/home/test \
          -e TEST_LOGIN_NAME=test \
          -e TEST_PASSWORD=test \
          -e TEST_PUBLIC_KEY_SSH=/home/test/.ssh/id_rsa.pub \
          -e TEST_PRIVATE_KEY_SSH=/home/test/.ssh/id_rsa \
          -e TEST_MOUNT_OPERATIONS=no \
          -v $(HOME):$(HOME) \
          -v $(PWD):/media/home \
          --device `cdemu device-mapping |$(TAIL) -n +3|$(GREP) 0|$(TR) -s ' '|$(CUT) -d ' ' -f 2` \
          -v `cdemu device-mapping |$(TAIL) -n +3|$(GREP) 0|$(TR) -s ' '|$(CUT) -d ' ' -f 2`:/dev/sr0 \
          -w $(PWD) \
          --name=bar \
          bar \
          /bin/bash -c "echo export PS1=\'$(DOCKER_PROMPT)\' >> ~/.bashrc && /bin/bash"

docker_run_win32-x86_64:
	( \
          $(DOCKER) $(DOCKER_RUN_FLAGS) \
            --rm \
            --net=host \
            -e COLUMNS="`tput cols`" -e LINES="`tput lines`" \
            -v $(PWD):/media/home \
            -v $(WINE_C_DRIVE):/media/wine \
            --name=bar-win32-x86_64 \
            bar-mingw32 setarch x86_64 -- /media/home/packages/build_win32.sh \
              -s \
              $(PACKAGE_NAME) \
              $(DISTRIBUTION_NAME).tar.bz2 \
              $(VERSION) \
              $(shell id -u):$(shell id -g) \
              $(WINE) \
              $(PACKAGE_NAME)-setup-$(VERSION); \
        )


# RPM
.PHONY: rpm rpmd clean_rpm
rpm: \
  rpm32 \
  rpm64
rpmd: \
  rpm32d \
  rpm64d

.PHONY: rpm32 rpm32d rpm64 rpm64d
rpm32: \
  $(DISTRIBUTION_NAME).rpm
rpm32d:
	$(MAKE) $(DISTRIBUTION_NAME).rpm PACKAGE_DEBUG=1
rpm64: \
  $(DISTRIBUTION_NAME)-x86_64.rpm
rpm64d:
	$(MAKE) $(DISTRIBUTION_NAME)-x86_64.rpm PACKAGE_DEBUG=1

clean_rpm:
	$(RMF) build/rpm/$(DISTRIBUTION_NAME).rpm
	$(RMF) build/rpm/$(DISTRIBUTION_NAME).rpm.log
	$(RMF) build/rpm/$(DISTRIBUTION_NAME)-x86_64.rpm
	$(RMF) build/rpm/$(DISTRIBUTION_NAME)-x86_64.rpm.log

$(DISTRIBUTION_NAME)-x86_64.rpm: \
  $(DISTRIBUTION_NAME).tar.bz2
	@$(call functionPrintInfo,Build RPM on AlmaLinux)
	@( \
          $(DOCKER) $(DOCKER_RUN_FLAGS) \
            --rm \
            --net=host \
            --user $(shell id -u):$(shell id -g) \
            -e COLUMNS="`tput cols`" -e LINES="`tput lines`" \
            -v $(PWD):/media/home \
            bar-rpm setarch x86_64 -- /bin/bash -c "make -C /media/home build_rpm PACKAGE_DEBUG=$(PACKAGE_DEBUG)" \
        ) | tee $@.log
	@$(call functionPrintResult,OK)

.PHONY: build_rpm
build_rpm:
	install -d build/rpm
	(cd build/rpm; \
         ../../packages/build_rpm.sh \
           ../.. \
           $(PACKAGE_NAME) \
           ../../$(DISTRIBUTION_NAME).tar.bz2 \
           $(VERSION) \
           $(shell id -u):$(shell id -g) \
           $(DISTRIBUTION_NAME)-x86_64.rpm \
           $(if $(PACKAGE_DEBUG),--debug) \
           ; \
        )

# DEB
.PHONY: deb debd clean_deb
deb: \
  deb32 \
  deb64
debd: \
  deb32d \
  deb64d

.PHONY: deb32 deb32d deb-gui32 deb-gui32d deb64 deb64d deb-gui64 deb-gui64d
deb32: \
  $(DISTRIBUTION_NAME).deb
deb32d:
	$(MAKE) $(DISTRIBUTION_NAME).deb PACKAGE_DEBUG=1
deb-gui32: \
  $(DISTRIBUTION_NAME_GUI).deb
deb-gui32d:
	$(MAKE) $(DISTRIBUTION_NAME_GUI).deb PACKAGE_DEBUG=1
deb64: \
  $(DISTRIBUTION_NAME)-x86_64.deb
deb64d:
	$(MAKE) $(DISTRIBUTION_NAME)-x86_64.deb PACKAGE_DEBUG=1
deb-gui64: \
  $(DISTRIBUTION_NAME_GUI)-x86_64.deb
deb-gui64d:
	$(MAKE) $(DISTRIBUTION_NAME_GUI)-x86_64.deb PACKAGE_DEBUG=1

clean_deb:
	$(RMF) build/rpm/$(DISTRIBUTION_NAME).deb
	$(RMF) build/rpm/$(DISTRIBUTION_NAME_GUI).deb
	$(RMF) build/rpm/$(DISTRIBUTION_NAME).deb.log
	$(RMF) build/rpm/$(DISTRIBUTION_NAME)-x86_64.deb
	$(RMF) build/rpm/$(DISTRIBUTION_NAME_GUI)-x86_64.deb
	$(RMF) build/rpm/$(DISTRIBUTION_NAME)-x86_64.deb.log

$(DISTRIBUTION_NAME)-x86_64.deb $(DISTRIBUTION_NAME_GUI)-x86_64.deb: \
  $(DISTRIBUTION_NAME).tar.bz2
	@$(call functionPrintInfo,Build DEB on Debian)
	( \
          $(DOCKER) $(DOCKER_RUN_FLAGS) \
            --rm \
            --net=host \
            --user $(shell id -u):$(shell id -g) \
            -e COLUMNS="`tput cols`" -e LINES="`tput lines`" \
            -v $(PWD):/media/home \
            bar-deb setarch x86_64 -- /bin/bash -c "make -C /media/home build_deb PACKAGE_DEBUG=$(PACKAGE_DEBUG)" \
        ) | tee $@.log
	@$(call functionPrintResult,OK)

# TODO: out-of-source build, distribution file
.PHONY: build_deb
build_deb:
	install -d build/deb
	(cd build/deb; \
	 ../../packages/build_deb.sh \
           ../.. \
           $(PACKAGE_NAME) \
           ../../$(DISTRIBUTION_NAME).tar.bz2 \
           $(VERSION) \
           $(shell id -u):$(shell id -g) \
           $(DISTRIBUTION_NAME)-x86_64.deb \
           $(DISTRIBUTION_NAME_GUI)-x86_64.deb \
           $(if $(PACKAGE_DEBUG),--debug); \
        )

# Windows setup
.PHONY: win32 win32d clean_win32
win32:
	$(MAKE) $(PACKAGE_NAME)-setup-$(VERSION)@EXEEXT@
win32d:
	$(MAKE) $(PACKAGE_NAME)-setup-$(VERSION)@EXEEXT@ PACKAGE_DEBUG=1

clean_win32:
	$(RMF) build/rpm/$(DISTRIBUTION_NAME).rpm
	$(RMF) build/rpm/$(DISTRIBUTION_NAME).rpm.log
	$(RMF) build/rpm/$(DISTRIBUTION_NAME)-x86_64.rpm
	$(RMF) build/rpm/$(DISTRIBUTION_NAME)-x86_64.rpm.log

#TODO: remove /media/wine and move to build_win32.sh
$(PACKAGE_NAME)-setup-$(VERSION)@EXEEXT@: \
  $(DISTRIBUTION_NAME).tar.bz2
	@$(call functionPrintInfo,Build Win32 on mingw32)
	( \
          $(DOCKER) $(DOCKER_RUN_FLAGS) \
            --rm \
            --net=host \
            --user $(shell id -u):$(shell id -g) \
            -e COLUMNS="`tput cols`" -e LINES="`tput lines`" \
            -v $(PWD)/extern:/media/extern \
            -v $(PWD):/media/home \
            -v $(WINE_C_DRIVE):/media/wine \
            bar-mingw32 setarch x86_64 -- /bin/bash -c "make -C /media/home build_win32 PACKAGE_DEBUG=$(PACKAGE_DEBUG)" \
        ) | tee $@.log
	@$(call functionPrintResult,OK)

.PHONY: build_win32
build_win32:
	install -d build/win32
	(cd build/win32; \
	 ../../packages/build_win32.sh \
           ../.. \
           $(PACKAGE_NAME) \
           ../../$(DISTRIBUTION_NAME).tar.bz2 \
           $(VERSION) \
           $(shell id -u):$(shell id -g) \
           $(PACKAGE_NAME)-setup-$(VERSION) \
           $(if $(PACKAGE_DEBUG),--debug); \
        )

# install test

# call functionInstallTestRPM,<docker image>,<architecture>,<RPM files>,<options>
functionInstallTestRPM = \
  if test -f /.dockerenv; then \
    packages/install_test_rpm.sh \
      $3 $4; \
  else \
    if test -n "$(DOCKER)"; then \
      $(DOCKER) $(DOCKER_RUN_FLAGS) \
        --rm \
        -e COLUMNS="`tput cols`" -e LINES="`tput lines`" \
        -v $(PWD):/media/home \
        $1 `if test -n "$2"; then echo "setarch $2 --"; fi` \
        /media/home/packages/install_test_rpm.sh \
          $(addprefix /media/home/,$3) \
          $4; \
    else \
      $(ECHO) "ERROR: no docker command available!"; \
    fi; \
  fi

# call functionInstallTestDEB,<docker image>,<architecture>,<version>,<DEB files>,<options>
functionInstallTestDEB = \
  if test -f /.dockerenv; then \
    packages/install_test_deb.sh \
      $3 $4; \
  else \
    if test -n "$(DOCKER)"; then \
      $(DOCKER) $(DOCKER_RUN_FLAGS) \
        --rm \
        -e COLUMNS="`tput cols`" -e LINES="`tput lines`" \
        -v $(PWD):/media/home \
        $1 `if test -n "$2"; then echo "setarch $2 --"; fi` \
        /media/home/packages/install_test_deb.sh \
          $(addprefix /media/home/,$3) \
          $4; \
    else \
      $(ECHO) "ERROR: no docker command available!"; \
    fi; \
  fi

# call functionInstallTestWin32,<docker image>,<architecture>,<version>,<setup files>,<options>
functionInstallTestWin32 = \
  if test -f /.dockerenv; then \
    packages/install_test_deb.sh \
      $3; \
  else \
    if test -n "$(DOCKER)"; then \
      $(DOCKER) $(DOCKER_RUN_FLAGS) \
        --rm \
--net=host \
        -e COLUMNS="`tput cols`" -e LINES="`tput lines`" \
        -v $(PWD):/media/home \
        $1 `if test -n "$2"; then echo "setarch $2 --"; fi` \
        /media/home/packages/install_test_win32.sh \
          $(addprefix /media/home/,$3) \
          $4; \
    else \
      $(ECHO) "ERROR: no docker command available!"; \
    fi; \
  fi

.PHONY: install_test
install_test:
	@$(MAKE) QUIET=1 \
          install_test_rpm \
          install_test_deb \
          install_test_win32

.PHONY: install_test_rpm install_test_rpmd
install_test_rpm: \
  install_test_rpm_almalinux \
  install_test_rpm_fedora \
  install_test_rpm_opensuse
install_test_rpmd: \
  install_test_rpm_almalinuxd \
  install_test_rpm_fedorad \
  install_test_rpm_opensused

.PHONY: install_test_rpm_almalinux install_test_rpm_almalinuxd
install_test_rpm_almalinux: \
  $(foreach i,$(TEST_PACKAGES_ALMALINUX),install_test_rpm_almalinux$i-x86_64)
install_test_rpm_almalinuxd: \
  $(foreach i,$(TEST_PACKAGES_ALMALINUX),install_test_rpm_almalinux$i-x86_64d)

.PHONY: install_test_rpm_fedora install_test_rpm_fedorad
install_test_rpm_fedora: \
  $(foreach i,$(TEST_PACKAGES_FEDORA),install_test_rpm_fedora$i-x86_64)
install_test_rpm_fedorad: \
  $(foreach i,$(TEST_PACKAGES_FEDORA),install_test_rpm_fedora$i-x86_64d)

.PHONY: install_test_rpm_opensuse install_test_rpm_opensused
install_test_rpm_opensuse: \
  install_test_rpm_opensuse-tumbleweed-x86_64 \
  $(foreach i,$(TEST_PACKAGES_OPENSUSE_LEAP),install_test_rpm_opensuse-leap$i-x86_64)
install_test_rpm_opensused: \
  install_test_rpm_opensuse-tumbleweed-x86_64d \
  $(foreach i,$(TEST_PACKAGES_OPENSUSE_LEAP),install_test_rpm_opensuse-leap$i-x86_64d)

.PHONY: $(foreach i,$(TEST_PACKAGES_ALMALINUX),install_test_rpm_almalinux$i-x86_64) $(foreach i,$(TEST_PACKAGES_ALMALINUX),install_test_rpm_almalinux$i-x86_64d)
install_test_rpm_almalinux%-x86_64: $(DISTRIBUTION_NAME)-x86_64.rpm
	@$(call functionPrintInfo,Test install almalinux $* 64bit)
	$(call functionInstallTestRPM,almalinux:$*,,$(DISTRIBUTION_NAME)-x86_64.rpm) $(if $(QUIET),1>/dev/null)
	$(call functionPrintResult,OK)
install_test_rpm_almalinux%-x86_64d: $(DISTRIBUTION_NAME)-x86_64.rpm
	@$(call functionPrintInfo,Test install almalinux $* 64bit)
	$(call functionInstallTestRPM,almalinux:$*,,$(DISTRIBUTION_NAME)-x86_64.rpm,--debug) $(if $(QUIET),1>/dev/null)
	$(call functionPrintResult,OK)

.PHONY: $(foreach i,$(TEST_PACKAGES_FEDORA),install_test_rpm_fedora$i-x86_64) $(foreach i,$(TEST_PACKAGES_FEDORA),install_test_rpm_fedora$i-x86_64d)
install_test_rpm_fedora%-x86_64:
	@$(call functionPrintInfo,Test install Fedora $* 64bit)
	@$(call functionInstallTestRPM,fedora:$*,,$(DISTRIBUTION_NAME)-x86_64.rpm) $(if $(QUIET),1>/dev/null)
	@$(call functionPrintResult,OK)
install_test_rpm_fedora%-x86_64d:
	@$(call functionPrintInfo,Test install Fedora $* 64bit)
	@$(call functionInstallTestRPM,fedora:$*,,$(DISTRIBUTION_NAME)-x86_64.rpm,--debug) $(if $(QUIET),1>/dev/null)
	@$(call functionPrintResult,OK)

.PHONY: install_test_rpm_opensuse-tumbleweed-x86_64 install_test_rpm_opensuse-tumbleweed-x86_64d
install_test_rpm_opensuse-tumbleweed-x86_64:
	@$(call functionPrintInfo,Test install OpenSuSE tumbleweed 64bit)
	@$(call functionInstallTestRPM,opensuse/tumbleweed,,x86_64,$(DISTRIBUTION_NAME)-x86_64.rpm) $(if $(QUIET),1>/dev/null)
	@$(call functionPrintResult,OK)
install_test_rpm_opensuse-tumbleweed-x86_64d:
	@$(call functionPrintInfo,Test install OpenSuSE tumbleweed 64bit)
	@$(call functionInstallTestRPM,opensuse/tumbleweed,,x86_64,$(DISTRIBUTION_NAME)-x86_64.rpm,--debug) $(if $(QUIET),1>/dev/null)
	@$(call functionPrintResult,OK)
.PHONY: $(foreach i,$(TEST_PACKAGES_OPENSUSE_LEAP),install_test_rpm_opensuse-leap$i-x86_64) $(foreach i,$(TEST_PACKAGES_OPENSUSE_LEAP),install_test_rpm_opensuse-leap$i-x86_64d)
install_test_rpm_opensuse-leap%-x86_64:
	@$(call functionPrintInfo,Test install OpenSuSE Leap $* 64bit)
	@$(call functionInstallTestRPM,opensuse/leap:$*,,$(DISTRIBUTION_NAME)-x86_64.rpm) $(if $(QUIET),1>/dev/null)
	@$(call functionPrintResult,OK)
install_test_rpm_opensuse-leap%-x86_64d:
	@$(call functionPrintInfo,Test install OpenSuSE Leap $* 64bit)
	@$(call functionInstallTestRPM,opensuse/leap:$*,,$(DISTRIBUTION_NAME)-x86_64.rpm,--debug) $(if $(QUIET),1>/dev/null)
	@$(call functionPrintResult,OK)

.PHONY: install_test_deb install_test_deb
install_test_deb: \
  install_test_deb_debian \
  install_test_deb_ubuntu
install_test_debd: \
  install_test_deb_debiand \
  install_test_deb_ubuntud

.PHONY: install_test_deb_debian install_test_deb_debiand
install_test_deb_debian: \
  $(foreach i,$(TEST_PACKAGES_DEBIAN),install_test_deb_debian$i-x86_64)
install_test_deb_debiand: \
  $(foreach i,$(TEST_PACKAGES_DEBIAN),install_test_deb_debian$i-x86_64d)

.PHONY: install_test_deb_ubuntu install_test_deb_ubuntud
install_test_deb_ubuntu: \
  $(foreach i,$(TEST_PACKAGES_UBUNTU),install_test_deb_ubuntu$i-x86_64)
install_test_deb_ubuntud: \
  $(foreach i,$(TEST_PACKAGES_UBUNTU),install_test_deb_ubuntu$i-x86_64d)

.PHONY: $(foreach i,$(TEST_PACKAGES_DEBIAN),install_test_deb_debian$i-x86_64) $(foreach i,$(TEST_PACKAGES_DEBIAN),install_test_deb_debian$i-x86_64d)
install_test_deb_debian%-x86_64:
	@$(call functionPrintInfo,Test install Debian $* 64bit)
	@$(call functionInstallTestDEB,debian:$*,x86_64,$(DISTRIBUTION_NAME)-x86_64.deb $(DISTRIBUTION_NAME_GUI)-x86_64.deb) $(if $(QUIET),1>/dev/null)
	@$(call functionPrintResult,OK)
install_test_deb_debian%-x86_64d:
	@$(call functionPrintInfo,Test install Debian $* 64bit)
	@$(call functionInstallTestDEB,debian:$*,x86_64,$(DISTRIBUTION_NAME)-x86_64.deb $(DISTRIBUTION_NAME_GUI)-x86_64.deb,--debug) $(if $(QUIET),1>/dev/null)
	@$(call functionPrintResult,OK)

.PHONY: $(foreach i,$(TEST_PACKAGES_UBUNTU),install_test_deb_ubuntu$i-x86_64) $(foreach i,$(TEST_PACKAGES_UBUNTU),install_test_deb_ubuntu$i-x86_64d)
install_test_deb_ubuntu%-x86_64:
	@$(call functionPrintInfo,Test install Ubuntu $* 64bit)
	@$(call functionInstallTestDEB,ubuntu:$*,x86_64,$(DISTRIBUTION_NAME)-x86_64.deb $(DISTRIBUTION_NAME_GUI)-x86_64.deb) $(if $(QUIET),1>/dev/null)
	@$(call functionPrintResult,OK)
install_test_deb_ubuntu%-x86_64d:
	@$(call functionPrintInfo,Test install Ubuntu $* 64bit)
	@$(call functionInstallTestDEB,ubuntu:$*,x86_64,$(DISTRIBUTION_NAME)-x86_64.deb $(DISTRIBUTION_NAME_GUI)-x86_64.deb,--debug) $(if $(QUIET),1>/dev/null)
	@$(call functionPrintResult,OK)

.PHONY: install_test_win32 install_test_win32d
install_test_win32:
	@$(call functionPrintInfo,Test install Windows 64bit)
	$(call functionInstallTestWin32,ubuntu:20.04,x86_64,$(PACKAGE_NAME)-setup-$(VERSION)@EXEEXT@) $(if $(QUIET),1>/dev/null)
	@$(call functionPrintResult,OK)
install_test_win32d:
	@$(call functionPrintInfo,Test install Windows 64bit)
	$(call functionInstallTestWin32,ubuntu:20.04,x86_64,$(PACKAGE_NAME)-setup-$(VERSION)@EXEEXT@,--debug) $(if $(QUIET),1>/dev/null)
	@$(call functionPrintResult,OK)

# GUI
.PHONY: gui clean_gui

gui: \
  $(DISTRIBUTION_NAME_GUI).zip

clean_gui:
	$(RMF) $(DISTRIBUTION_NAME_GUI).zip

# TODO: how to include barcontrol.exe in GUI distribution? Always do a Windows build?
ifeq ($(ENABLE_GUI),yes)
$(DISTRIBUTION_NAME_GUI).zip: \
  barcontrol/barcontrol \
  barcontrol/barcontrol.cmd \
  $(if $(findstring $(PLATFORM),WINDOWS),$(if $(LAUNCH4JC),barcontrol/barcontrol@EXEEXT@)) \
  barcontrol/barcontrol-linux.jar \
  barcontrol/barcontrol-linux_64.jar \
  barcontrol/barcontrol-windows.jar \
  barcontrol/barcontrol-windows_64.jar \
  barcontrol/barcontrol-solaris.jar \
  barcontrol/barcontrol-macosx.jar \
  barcontrol/barcontrol-macosx_64.jar
	$(INSTALL) -d tmp/gui/linux
	$(INSTALL) -t tmp/gui/linux \
	           -m 775 \
                   barcontrol/barcontrol
	$(INSTALL) -t tmp/gui/linux \
	           -m 664 \
                   barcontrol/barcontrol-linux.jar \
                   barcontrol/barcontrol-linux_64.jar
	#
	$(INSTALL) -d tmp/gui/windows
	$(INSTALL) -t tmp/gui/windows \
	           -m 775 \
                   barcontrol/barcontrol.cmd \
	                 $(if $(LAUNCH4JC),barcontrol/barcontrol@EXEEXT@)
	$(INSTALL) -t tmp/gui/windows \
	           -m 664 \
                   barcontrol/barcontrol-windows.jar \
                   barcontrol/barcontrol-windows_64.jar
	#
	$(INSTALL) -d tmp/gui/solaris
	$(INSTALL) -t tmp/gui/solaris \
	           -m 775 \
                   barcontrol/barcontrol
	$(INSTALL) -t tmp/gui/solaris \
	           -m 664 \
                   barcontrol/barcontrol-solaris.jar
	#
	$(INSTALL) -d tmp/gui/macosx
	$(INSTALL) -t tmp/gui/macosx \
	           -m 775 \
                   barcontrol/barcontrol
	$(INSTALL) -t tmp/gui/macosx \
	           -m 664 \
                   barcontrol/barcontrol-macosx.jar \
                   barcontrol/barcontrol-macosx_64.jar

	($(CD) tmp/gui; $(ZIP) -r ../../$@ linux windows solaris macosx)
	$(RMRF) tmp/gui
	#
ifneq ($(MD5SUM),)
	$(MD5SUM) $@
endif
endif

.PHONY: setup
setup:
	#install packages/backup-archiver.iss backup-archiver.iss
	$(WINE) "$(ISCC)" \
  /O$(PROJECT_ROOT) \
  /F$(PACKAGE_NAME)-setup-$(VERSION) \
  packages/backup-archiver.iss

# end of file
